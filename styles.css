:root {
  --bg: #0a0a0b; --surface: #111113; --surface2: #18181b; --surface3: #27272a;
  --border: rgba(255,255,255,.08); --border-hover: rgba(255,255,255,.12);
  --text: #fafafa; --muted: #a1a1aa; --dim: #52525b;
  --accent: #22c55e; --accent-bg: rgba(34,197,94,.12);
  --warn: #f59e0b; --error: #ef4444; --purple: #8b5cf6;
  --radius: 8px; --transition: all .2s cubic-bezier(.4,0,.2,1);
  --safe-b: env(safe-area-inset-bottom,0); --safe-t: env(safe-area-inset-top,0);
}

*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
html, body { height: 100dvh; overflow: hidden; overscroll-behavior: none; }
body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); -webkit-font-smoothing: antialiased; touch-action: none; }
.hidden { opacity: 0 !important; visibility: hidden !important; pointer-events: none !important; }

/* Canvas */
#c { position: fixed; inset: 0; width: 100vw; height: 100dvh; background: var(--bg); z-index: 1; touch-action: none; }

/* Overlays */
.overlay { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: grid; place-items: center; padding: 20px; transition: var(--transition); }
.overlay.reconnecting h2 { color: var(--warn); }

.card { display: flex; flex-direction: column; align-items: center; width: 100%; max-width: 300px; text-align: center; }
.card h2 { font-size: 18px; margin-bottom: 4px; }
.card .muted { font-size: 12px; color: var(--dim); margin-bottom: 16px; }
.card .icon { width: 40px; height: 40px; margin-bottom: 12px; color: var(--accent); fill: none; stroke: currentColor; stroke-width: 2; }
.card label { width: 100%; text-align: left; font-size: 10px; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: .05em; margin-bottom: 12px; }
.card input { width: 100%; margin-top: 4px; padding: 10px 12px; background: var(--surface); border: 1.5px solid var(--border); border-radius: var(--radius); color: var(--text); font-size: 14px; outline: none; transition: var(--transition); }
.card input::placeholder { color: var(--dim); }
.card input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-bg); }
.card input.error { border-color: var(--error); animation: shake .4s; }
.card input.pin { text-align: center; letter-spacing: 6px; font-size: 18px; font-family: monospace; }
.card .error { font-size: 11px; color: var(--error); min-height: 18px; margin: 8px 0; }
.card button.primary { width: 100%; padding: 10px; background: var(--accent); border: none; border-radius: var(--radius); color: #000; font-size: 13px; font-weight: 600; cursor: pointer; transition: var(--transition); }
.card button.primary:hover { background: #2dd66b; transform: translateY(-1px); }
.card button.primary:disabled { opacity: .5; cursor: not-allowed; }

@keyframes shake { 0%,100% { transform: translateX(0); } 20%,60% { transform: translateX(-6px); } 40%,80% { transform: translateX(6px); } }

/* Spinner */
.spinner { position: relative; width: 48px; height: 48px; margin-bottom: 16px; }
.spinner i { position: absolute; inset: 0; border-radius: 50%; border: 2px solid transparent; }
.spinner i:nth-child(1) { border-top-color: var(--accent); animation: spin 1s linear infinite; }
.spinner i:nth-child(2) { inset: 5px; border-right-color: var(--purple); animation: spin 1.4s linear infinite reverse; }
.spinner i:nth-child(3) { inset: 10px; border-bottom-color: var(--dim); animation: spin 1.8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* Stages */
.stages { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; margin-top: 16px; }
.stages span { display: flex; align-items: center; gap: 6px; padding: 6px 10px; background: var(--surface); border: 1px solid var(--border); border-radius: 6px; font-size: 11px; font-weight: 500; color: var(--muted); transition: var(--transition); }
.stages span::before { content: ''; width: 6px; height: 6px; border-radius: 50%; background: var(--dim); transition: var(--transition); }
.stages span::after { content: attr(data-label); }
.stages span.active { background: var(--surface2); border-color: var(--border-hover); color: var(--text); }
.stages span.active::before { background: var(--warn); box-shadow: 0 0 6px var(--warn); animation: pulse 1.5s infinite; }
.stages span.done { background: rgba(34,197,94,.06); border-color: rgba(34,197,94,.15); color: var(--accent); }
.stages span.done::before { background: var(--accent); box-shadow: 0 0 6px var(--accent); animation: none; }
.stages span.error { background: rgba(239,68,68,.06); border-color: rgba(239,68,68,.15); }
.stages span.error::before { background: var(--error); box-shadow: 0 0 6px var(--error); }
@keyframes pulse { 50% { opacity: .4; transform: scale(.85); } }

/* Edge trigger & Backdrop */
.edge { position: fixed; right: 0; top: 50%; transform: translateY(-50%); width: 3px; height: 32px; background: rgba(255,255,255,.05); border-radius: 3px 0 0 3px; border: none; cursor: pointer; z-index: 100; opacity: 0; transition: var(--transition); }
.edge::before { content: ''; position: absolute; inset: -30px -15px -30px -50px; }
.edge::after { content: ''; position: absolute; top: 50%; left: 0; transform: translateY(-50%); width: 3px; height: 10px; background: rgba(255,255,255,.15); border-radius: 2px; transition: var(--transition); }
.edge:hover { opacity: 1; width: 4px; background: rgba(34,197,94,.1); }
.edge:hover::after { height: 16px; background: var(--accent); box-shadow: 0 0 10px rgba(34,197,94,.4); }
@media (hover: hover) { .edge { opacity: 1; } }
.edge.open, .edge.on { opacity: 0; pointer-events: none; }

.backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.6); backdrop-filter: blur(6px); z-index: 200; transition: var(--transition); }

/* Panel */
.panel { position: fixed; right: 12px; top: 50%; transform: translateY(-50%) translateX(calc(100% + 24px)); width: 260px; max-width: calc(100vw - 24px); max-height: calc(100vh - 24px); background: var(--surface); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 12px 48px rgba(0,0,0,.4); z-index: 300; display: flex; flex-direction: column; overflow: hidden; transition: var(--transition); }
.panel:not(.hidden), .panel.on { transform: translateY(-50%) translateX(0); }
.panel header { display: flex; align-items: center; justify-content: space-between; padding: 12px 14px; border-bottom: 1px solid var(--border); font-size: 14px; font-weight: 600; }
.panel header button { width: 26px; height: 26px; display: grid; place-items: center; background: transparent; border: none; border-radius: 6px; color: var(--dim); font-size: 18px; cursor: pointer; transition: var(--transition); }
.panel header button:hover { background: var(--surface2); color: var(--text); }
.panel .content { flex: 1; overflow-y: auto; padding: 10px 14px; }
.panel .content::-webkit-scrollbar { width: 3px; }
.panel .content::-webkit-scrollbar-thumb { background: var(--surface3); border-radius: 2px; }

.panel section { margin-bottom: 14px; }
.panel section:last-child { margin-bottom: 0; }
.panel h3 { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: .1em; color: var(--dim); margin-bottom: 8px; }

.panel .row { display: flex; gap: 8px; }
.panel .row button { flex: 1; }

.panel button:not(.toggle):not(.primary) { display: flex; align-items: center; justify-content: center; gap: 6px; width: 100%; padding: 9px 12px; background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text); font-size: 12px; font-weight: 500; cursor: pointer; transition: var(--transition); }
.panel button:not(.toggle):not(.primary):hover { background: var(--surface3); border-color: var(--border-hover); }
.panel button:not(.toggle):not(.primary).on { background: var(--accent-bg); border-color: var(--accent); color: var(--accent); }
.panel button svg { width: 14px; height: 14px; fill: none; stroke: currentColor; stroke-width: 2; opacity: .7; }
.panel button.on svg { opacity: 1; color: var(--accent); }

.panel label.inline { display: flex; align-items: center; justify-content: space-between; gap: 8px; margin-bottom: 8px; font-size: 12px; font-weight: 500; }
.panel select { flex: 1; min-width: 0; padding: 8px 28px 8px 10px; background: var(--surface2) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2352525b' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E") no-repeat right 8px center; border: 1px solid var(--border); border-radius: var(--radius); color: var(--text); font-size: 11px; font-weight: 500; cursor: pointer; appearance: none; transition: var(--transition); }
.panel select:hover { background-color: var(--surface3); border-color: var(--border-hover); }
.panel select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-bg); }

.panel .status { display: flex; align-items: center; gap: 6px; margin-top: 8px; padding: 6px 10px; background: var(--surface2); border-radius: 6px; font-size: 10px; color: var(--dim); }
.panel .status i { width: 5px; height: 5px; border-radius: 50%; background: var(--dim); transition: var(--transition); }
.panel .status.on { color: var(--muted); }
.panel .status.on i { background: var(--accent); box-shadow: 0 0 6px var(--accent); animation: pulse 2s infinite; }

.panel .toggle { display: flex; align-items: center; justify-content: space-between; padding: 10px; background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius); cursor: pointer; margin-bottom: 6px; transition: var(--transition); }
.panel .toggle:hover { background: var(--surface3); border-color: var(--border-hover); }
.panel .toggle i { width: 32px; height: 18px; background: var(--surface3); border-radius: 9px; position: relative; transition: var(--transition); }
.panel .toggle i::after { content: ''; position: absolute; top: 2px; left: 2px; width: 14px; height: 14px; background: var(--dim); border-radius: 50%; transition: all .2s; }
.panel .toggle.on i { background: var(--accent); }
.panel .toggle.on i::after { transform: translateX(14px); background: #fff; }

.panel .radio-group { display: flex; gap: 6px; }
.panel .radio-group label { display: flex; align-items: center; gap: 8px; flex: 1; padding: 8px 10px; background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius); cursor: pointer; transition: var(--transition); }
.panel .radio-group label:hover { background: var(--surface3); border-color: var(--border-hover); }
.panel .radio-group label:has(input:checked) { background: rgba(139,92,246,.1); border-color: var(--purple); }
.panel .radio-group input { display: none; }
.panel .radio-group span { font-size: 12px; font-weight: 500; }
.panel .radio-group span::before { content: ''; display: inline-block; width: 14px; height: 14px; margin-right: 8px; border: 2px solid var(--dim); border-radius: 50%; vertical-align: middle; transition: var(--transition); }
.panel .radio-group label:has(input:checked) span::before { border-color: var(--purple); background: var(--purple); box-shadow: inset 0 0 0 3px var(--surface2); }

/* Stats */
.stats { position: fixed; top: calc(10px + var(--safe-t)); left: 10px; z-index: 150; background: rgba(10,10,11,.92); border: 1px solid var(--border); border-radius: var(--radius); padding: 10px; min-width: 340px; max-width: calc(100vw - 20px); font: 9px/1.4 monospace; box-shadow: 0 6px 24px rgba(0,0,0,.3); max-height: calc(100vh - 60px); overflow-y: auto; transform: translateY(-8px) scale(.98); transition: var(--transition); }
.stats:not(.hidden), .stats.on { transform: none; }
.stats::-webkit-scrollbar { width: 3px; }
.stats::-webkit-scrollbar-thumb { background: var(--surface3); border-radius: 2px; }
.stats .ss { margin-bottom: 8px; }
.stats .ss:last-child { margin-bottom: 0; }
.stats .sst { font-size: 8px; font-weight: 700; text-transform: uppercase; letter-spacing: .08em; color: var(--accent); margin-bottom: 3px; padding-bottom: 2px; border-bottom: 1px solid var(--border); }
.stats .sr { display: flex; justify-content: space-between; padding: 1px 0; color: var(--muted); }
.stats .sr span:first-child { color: var(--dim); }
.stats .sv { font-weight: 500; font-variant-numeric: tabular-nums; }
.stats .g { color: var(--accent); }
.stats .w { color: var(--warn); }
.stats .r { color: var(--error); }

/* Console */
.console { position: fixed; bottom: calc(10px + var(--safe-b)); left: 10px; z-index: 150; background: rgba(10,10,11,.92); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: 0 6px 24px rgba(0,0,0,.3); width: 380px; max-width: calc(100vw - 20px); max-height: 26vh; display: flex; flex-direction: column; transform: translateY(8px) scale(.98); transition: var(--transition); overflow: hidden; }
.console:not(.hidden), .console.on { transform: none; }
.console header { display: flex; align-items: center; justify-content: space-between; padding: 6px 10px; border-bottom: 1px solid var(--border); }
.console header span { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: .05em; color: var(--dim); }
.console header button { font-size: 9px; font-weight: 600; color: var(--dim); background: var(--surface2); border: 1px solid var(--border); padding: 2px 6px; border-radius: 4px; cursor: pointer; transition: var(--transition); }
.console header button:hover { background: var(--surface3); color: var(--muted); }
.console .logs { flex: 1; overflow-y: auto; padding: 6px 10px; font: 9px/1.4 monospace; }
.console .logs::-webkit-scrollbar { width: 3px; }
.console .logs::-webkit-scrollbar-thumb { background: var(--surface3); border-radius: 2px; }
.console .le { display: flex; gap: 6px; padding: 1px 0; border-bottom: 1px solid rgba(255,255,255,.02); }
.console .le:last-child { border-bottom: none; }
.console .le .lt { color: var(--dim); font-size: 8px; flex-shrink: 0; }
.console .le.info .lm { color: var(--accent); }
.console .le.warn .lm { color: var(--warn); }
.console .le.error .lm { color: var(--error); }

/* Responsive */
.desktop-only { display: block; }
.touch-only { display: none; }
@media (pointer: coarse), (max-width: 640px) { .desktop-only { display: none; } .touch-only { display: block; } }

@media (max-width: 640px) {
  .panel { right: 8px; left: 8px; top: auto; bottom: 8px; width: auto; max-height: 55vh; transform: translateY(calc(100% + 24px)); border-radius: 10px; }
  .panel:not(.hidden), .panel.on { transform: none; }
  .stats, .console { left: 8px; right: 8px; width: auto; }
  .stats { min-width: 0; top: calc(8px + var(--safe-t)); }
  .console { bottom: calc(8px + var(--safe-b)); }
  .edge { height: 36px; }
}

@media (max-height: 480px) and (orientation: landscape) {
  .overlay { padding: 12px 20px; }
  .spinner { width: 32px; height: 32px; margin-bottom: 10px; }
  .card h2 { font-size: 14px; }
  .card .muted { font-size: 10px; margin-bottom: 10px; }
  .stages { gap: 4px; margin-top: 10px; }
  .stages span { padding: 4px 8px; font-size: 9px; }
  .panel { max-height: calc(100vh - 16px); right: 8px; top: 8px; bottom: 8px; transform: translateY(0) translateX(calc(100% + 16px)); }
  .panel:not(.hidden), .panel.on { transform: none; }
}

@media (prefers-reduced-motion: reduce) { *, *::before, *::after { animation-duration: .01ms !important; transition-duration: .01ms !important; } }
